<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Apartado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body { background: #f8f9fa; }
        .plan-option { cursor: pointer; transition: all 0.2s; }
        .plan-option.selected { border-color: #198754 !important; background: #d1e7dd; }
        @media print {
            body * { visibility: hidden; }
            #pdfContent, #pdfContent * { visibility: visible; }
            #pdfContent { position: absolute; left: 0; top: 0; width: 210mm; }
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <div class="card shadow-sm mx-auto" style="max-width: 800px;">
            <div class="card-header bg-primary text-white text-center py-2">
                <h5 class="mb-0">Sistema de Apartados - COP</h5>
            </div>
            <div class="card-body p-3">
                <form id="apartadoForm" class="row g-2">
                    <div class="col-md-8"><input type="text" class="form-control form-control-sm" id="productName" placeholder="Producto" value="Reloj/Perfume" required></div>
                    <div class="col-md-4"><input type="number" class="form-control form-control-sm" id="totalValue" placeholder="Valor" value="140000" min="1000" required></div>
                    <div class="col-md-6"><input type="text" class="form-control form-control-sm" id="clientName" placeholder="Nombre completo" value="Juan Pérez" required></div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="docType">
                            <option value="C.C.">C.C.</option>
                            <option value="C.E.">C.E.</option>
                        </select>
                    </div>
                    <div class="col-md-3"><input type="text" class="form-control form-control-sm" id="docNumber" placeholder="No. Doc" value="1037654321" required></div>
                    <div class="col-md-6"><input type="text" class="form-control form-control-sm" id="clientPhone" placeholder="Teléfono" value="3101234567" required></div>
                    <div class="col-md-6"><input type="date" class="form-control form-control-sm" id="startDate" required></div>
                    
                    <div class="col-12 mt-3">
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="border rounded p-2 plan-option" id="optionA" data-plan="A">
                                    <strong class="d-block">Opción A: 2 Meses</strong>
                                    <small class="text-muted">50% inicial</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2 plan-option" id="optionB" data-plan="B">
                                    <strong class="d-block">Opción B: 4 Meses</strong>
                                    <small class="text-muted">25% inicial</small>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="selectedPlan" required>
                    </div>
                    
                    <div class="col-12 mt-3">
                        <button type="submit" class="btn btn-primary btn-sm w-100">Generar Contrato</button>
                    </div>
                </form>

                <div id="resultsSection" class="mt-3" style="display:none;">
                    <div class="d-flex gap-2 mb-2">
                        <button class="btn btn-success btn-sm" onclick="generateCSV()">Descargar CSV</button>
                        <button class="btn btn-danger btn-sm" onclick="generatePDF()">Generar PDF</button>
                    </div>
                    <div id="paymentSummary" class="alert alert-success py-2 small mb-0"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="pdfContent" style="display:none; width:210mm; padding:15mm; font-size:10pt; background:white; color:#000;"></div>

    <script>
        const $ = id => document.getElementById(id);
        const formatCOP = n => new Intl.NumberFormat('es-CO', {style:'currency', currency:'COP', minimumFractionDigits:0}).format(n);
        const addMonths = (d, m) => { const nd = new Date(d); nd.setMonth(nd.getMonth() + m); return nd; };
        
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            $('startDate').value = today.toISOString().split('T')[0];
            
            ['optionA', 'optionB'].forEach(id => {
                $(id).addEventListener('click', function() {
                    document.querySelectorAll('.plan-option').forEach(el => el.classList.remove('selected'));
                    this.classList.add('selected');
                    $('selectedPlan').value = this.dataset.plan;
                });
            });
            
            $('apartadoForm').addEventListener('submit', e => {
                e.preventDefault();
                if (!$('selectedPlan').value) return alert('Seleccione un plan');
                generateContract();
            });
        });

        function generateContract() {
            const data = {
                product: $('productName').value,
                total: parseFloat($('totalValue').value),
                client: $('clientName').value,
                docType: $('docType').value,
                docNum: $('docNumber').value,
                phone: $('clientPhone').value,
                plan: $('selectedPlan').value,
                start: new Date($('startDate').value)
            };

            let payments = [];
            if (data.plan === 'A') {
                const p1 = Math.round(data.total * 0.5);
                payments = [
                    {n:1, desc:'Inicial (50%)', amt:p1, date:data.start},
                    {n:2, desc:'Final (50%)', amt:data.total-p1, date:addMonths(data.start, 2)}
                ];
            } else {
                const fixed = Math.round(data.total * 0.25);
                const adj = data.total - (fixed * 4);
                payments = [
                    {n:1, desc:'Inicial (25%)', amt:fixed+adj, date:data.start},
                    {n:2, desc:'Cuota 2', amt:fixed, date:addMonths(data.start, 1)},
                    {n:3, desc:'Cuota 3', amt:fixed, date:addMonths(data.start, 2)},
                    {n:4, desc:'Cuota 4', amt:fixed, date:addMonths(data.start, 3)}
                ];
            }

            const refundDate = addMonths(data.start, 1);
            const abandonDate = addMonths(payments[payments.length-1].date, 3);
            
            let tableRows = payments.map(p => 
                `<tr><td>${p.desc}</td><td>${formatCOP(p.amt)}</td><td>${p.date.toLocaleDateString('es-CO')}</td></tr>`
            ).join('');

            $('pdfContent').innerHTML = `
                <div style="font-family:Arial,sans-serif;">
                    <h3 style="text-align:center; color:#007bff; border-bottom:2px solid #007bff; padding-bottom:5px; margin-bottom:10px;">CONTRATO DE APARTADO</h3>
                    
                    <div style="margin-bottom:10px;">
                        <strong>CLIENTE:</strong> ${data.client} | <strong>${data.docType}</strong> ${data.docNum} | <strong>TEL:</strong> ${data.phone}<br>
                        <strong>PRODUCTO:</strong> ${data.product} | <strong>VALOR TOTAL:</strong> ${formatCOP(data.total)}<br>
                        <strong>PLAN:</strong> Opción ${data.plan} | <strong>INICIO:</strong> ${data.start.toLocaleDateString('es-CO')}
                    </div>

                    <h5 style="margin-top:15px; margin-bottom:5px;">PLAN DE PAGOS</h5>
                    <table style="width:100%; border-collapse:collapse; margin-bottom:10px; font-size:9pt;">
                        <thead><tr style="background:#f2f2f2;"><th style="border:1px solid #ddd; padding:4px;">Descripción</th><th style="border:1px solid #ddd; padding:4px;">Monto</th><th style="border:1px solid #ddd; padding:4px;">Fecha</th></tr></thead>
                        <tbody>${tableRows}</tbody>
                        <tfoot><tr><td colspan="2" style="text-align:right; border:1px solid #ddd; padding:4px;"><strong>TOTAL</strong></td><td style="border:1px solid #ddd; padding:4px;"><strong>${formatCOP(data.total)}</strong></td></tr></tfoot>
                    </table>

                    <h5 style="margin-top:15px; margin-bottom:5px;">TÉRMINOS Y CONDICIONES</h5>
                    <ol style="font-size:8pt; line-height:1.4; margin:0; padding-left:15px;">
                        <li><strong>Plazo:</strong> ${data.plan==='A'?'2 meses':'4 meses'} máximo para completar el 100% del pago.</li>
                        <li><strong>Entrega:</strong> Solo al completar el 100% del valor total.</li>
                        <li><strong>Devoluciones:</strong> Dentro de 30 días se devuelve el 100%. Después de 30 días o vencido el plazo, NO hay reembolso. <strong>Límite: ${refundDate.toLocaleDateString('es-CO')}</strong></li>
                        <li><strong>Abandono:</strong> 3 meses sin pago generan pérdida total del dinero. <strong>Límite: ${abandonDate.toLocaleDateString('es-CO')}</strong></li>
                        <li><strong>Precio fijo:</strong> ${formatCOP(data.total)} sin variaciones durante el apartado.</li>
                    </ol>

                    <div style="display:flex; justify-content:space-between; margin-top:40px; font-size:9pt;">
                        <div style="width:45%; border-top:1px solid #000; padding-top:5px; text-align:center;">
                            <strong>VENDEDOR</strong><br>C.C./C.E.:_______________
                        </div>
                        <div style="width:45%; border-top:1px solid #000; padding-top:5px; text-align:center;">
                            <strong>CLIENTE</strong><br>${data.docType}: ${data.docNum}
                        </div>
                    </div>
                    <p style="text-align:center; margin-top:15px; font-size:7pt;">Acepto los términos del presente contrato de apartado.</p>
                </div>
            `;

            $('paymentSummary').innerHTML = `✅ Contrato generado | ${payments.length} cuotas | Total: ${formatCOP(data.total)}`;
            $('resultsSection').style.display = 'block';
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const content = $('pdfContent');
            content.style.display = 'block';

            html2canvas(content, {scale:2}).then(canvas => {
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/png');
                const imgW = 210, imgH = canvas.height * imgW / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, imgW, imgH);
                pdf.save(`Contrato_${$('clientName').value.replace(/\s/g,'_')}.pdf`);
                content.style.display = 'none';
            });
        }

        function generateCSV() {
            const rows = [['Producto','Cliente','Total','Cuota','Monto','Fecha']];
            document.querySelectorAll('#pdfContent table tbody tr').forEach(tr => {
                const cells = tr.querySelectorAll('td');
                if(cells.length === 3) {
                    rows.push([
                        $('productName').value,
                        $('clientName').value,
                        $('totalValue').value,
                        cells[0].textContent,
                        cells[1].textContent.replace(/[^\d]/g,''),
                        cells[2].textContent
                    ]);
                }
            });
            
            const csv = rows.map(r => r.join(',')).join('\n');
            const blob = new Blob(['\ufeff' + csv], {type:'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Plan_${$('clientName').value.replace(/\s/g,'_')}.csv`;
            link.click();
        }
    </script>
</body>
</html>
